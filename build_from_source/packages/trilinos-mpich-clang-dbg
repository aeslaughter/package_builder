#!/bin/bash
#############
## Specifics
##
DEP=(modules cmake gcc llvm mpich-clang)
PACKAGE='trilinos-mpich-clang-dbg'

#####
# Set the operating system allowed to build this module
#
ARCH=(Darwin)

#####
# Setting any of these variables to 'false' effectively skips that step
# This is useful for items like 'autojump' which requires a git clone/checkout
DOWNLOAD='http://trilinos.csbsju.edu/download/files/trilinos-11.14.3-Source.tar.gz'
EXTRACT='trilinos-11.14.3-Source.tar.gz'
CONFIGURE="
cmake \
-D CMAKE_INSTALL_PREFIX:PATH=$PACKAGES_DIR/trilinos/mpich-clang-dbg \
-D CMAKE_INSTALL_NAME_DIR:STRING=$PACKAGES_DIR/trilinos/mpich-clang-dbg/lib \
-D CMAKE_BUILD_TYPE:STRING=DEBUG \
-D BUILD_SHARED_LIBS=ON \
-D CMAKE_VERBOSE_MAKEFILE:BOOL=OFF \
-D TPL_ENABLE_MPI:BOOL=ON \
-D TPL_ENABLE_MOAB=OFF \
-D TPL_ENABLE_BoostLib=OFF \
-D Trilinos_ENABLE_Ifpack=ON \
-D Trilinos_ENABLE_Ifpack2=ON \
-D Trilinos_ENABLE_Teuchos=ON \
-D Trilinos_ENABLE_ML=ON \
-D Trilinos_ENABLE_NOX=ON \
-D Trilinos_ENABLE_AztecOO=ON \
-D Trilinos_ENABLE_Epetra=ON \
-D Trilinos_ENABLE_EpetraExt=ON \
-D TPL_ENABLE_Libmesh=OFF \
-D MPI_BASE_DIR:PATH=$MPI_HOME \
-D Trilinos_ENABLE_CXX11:BOOL=ON \
-D Trilinos_ENABLE_ALL_OPTIONAL_PACKAGES:BOOL=OFF \
-D Trilinos_ASSERT_MISSING_PACKAGES=OFF \
-D Trilinos_EXTRA_REPOSITORIES=DataTransferKit \
-D DataTransferKit_FIND_DTK_DATA_DIR=../DataTransferKit \
-D Trilinos_ENABLE_DataTransferKit:BOOL=ON \
-D DataTransferKit_ENABLE_DBC:BOOL=ON \
-D DataTransferKit_ENABLE_TESTS:BOOL=ON \
-D DataTransferKit_ENABLE_EXAMPLES:BOOL=ON \
-D CMAKE_Fortran_FLAGS_DEBUG_OVERRIDE=-fPIC \
-D CMAKE_C_FLAGS_DEBUG_OVERRIDE=-fPIC \
-D CMAKE_CXX_FLAGS_DEBUG_OVERRIDE=-fPIC \
..
"
BUILD='true'
INSTALL='true'

pre_run() {
    unset MODULEPATH
    source $PACKAGES_DIR/Modules/3.2.10/init/bash
    module load advanced_modules cmake mpich-3.1.4_clang
    git clone https://github.com/ORNL-CEES/DataTransferKit.git
    cd DataTransferKit
    git checkout 76502c937b4ec52b521b617f9cc399e98dc53f0d
    cd ../
    cat <<EOF > clang.patch
diff -u -r trilinos-11.14.3-Source.orig/packages/nox/src-lapack/NOX_LAPACK_Matrix.H trilinos-11.14.3-Source/packages/nox/src-lapack/NOX_LAPACK_Matrix.H
--- trilinos-11.14.3-Source.orig/packages/nox/src-lapack/NOX_LAPACK_Matrix.H    2015-04-17 13:05:04.000000000 -0600
+++ trilinos-11.14.3-Source/packages/nox/src-lapack/NOX_LAPACK_Matrix.H 2015-10-09 15:35:37.000000000 -0600
@@ -104,7 +104,7 @@
         stream << operator()(i,j) << " ";
       stream << "]" << std::endl;
     }
-    return stream;
+    return stream.good();
       }

       //! Returns the number of rows in the matrix
EOF
    patch -p1 < clang.patch
    mkdir clang-dbg; cd clang-dbg
}

post_run() {
    cat <<EOF > $PACKAGES_DIR/Modules/3.2.10/modulefiles/moose/.mpich-trilinos-clang-dbg
#%Module1.0#####################################################################
##
##  Trilinos MPICH Clang Debug Module 
##
##
##
set          BASE_PATH          $PACKAGES_DIR

if { [uname sysname] != "Darwin" } {
  prepend-path         LD_LIBRARY_PATH     \$BASE_PATH/trilinos/mpich-clang-dbg/lib
}

setenv       TRILINOS_DIR                \$BASE_PATH/trilinos/mpich-clang-dbg
EOF
    cd $PACKAGES_DIR/Modules/3.2.10/mpich_clang
    ln -s ../modulefiles/moose/.mpich-trilinos-clang-dbg trilinos-dbg
}
##
## End Specifics
##############
## The following script contains all the common functions.
## Those functions are executed in the following order:

# download
# extract
# pre-run
# configure
# make
# make install
# post_run
# cleanup

## pre_run and post_run are the only true specifics that are different
## with every package
source $RELATIVE_DIR/functions
